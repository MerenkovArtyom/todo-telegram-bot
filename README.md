# Todo Telegram Bot

## Описание
Этот проект — Telegram‑бот для ведения списка задач. Он умеет принимать задачи в виде текста и голосовых сообщений, автоматически извлекать отдельные задачи из фразы, распознавать простые даты ("сегодня", "завтра", "послезавтра" или формат `dd.mm` / `dd/mm`) и сохранять задачи в локальную базу SQLite.

Бот построен на `aiogram` (v3), использует `openai-whisper` для распознавания речи и `ffmpeg` для конвертации аудио.

## Возможности
- Добавление задач через обычные сообщения или команду `/add`.
- Добавление задач из голосовых сообщений с подтверждением списка.
- Просмотр списка задач по команде `/list`.
- Отметка задачи выполненной по индексу через `/done`.
- Хранение задач в SQLite (`data/todo.db`) отдельно для каждого пользователя.
- Парсинг дат: `сегодня`, `завтра`, `послезавтра`, а также `dd.mm` и `dd/mm` (текущий год).

## Быстрый старт

### Требования
- Python 3.11+ (рекомендовано).
- `ffmpeg` в `PATH` для обработки голосовых сообщений.
- Telegram Bot Token от @BotFather.

### Установка зависимостей
```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
```

### Настройка окружения
Создайте файл `.env` в корне проекта и укажите токен бота:
```env
BOT_TOKEN=ваш_токен_бота
```

### Запуск
```bash
python -m app.main
```

## Использование

### Текстовые команды
- `/start` — показать краткую справку и кнопки.
- `/add <текст>` — добавить задачи из текста.
- `/list` — показать текущие задачи.
- `/done <номер>` — отметить задачу выполненной.

### Пример добавления
```
/add Купить молоко и оплатить интернет завтра
```
Бот разобьет фразу на задачи по союзу "и" и попытается определить дату для каждой задачи.

### Голосовые сообщения
1. Отправьте голосовое сообщение.
2. Бот распознает речь, выделит задачи и покажет предпросмотр.
3. Подтвердите добавление или отмените.

## Как работает разбор задач
- Текст разбивается по шаблону `\s+и\s+`.
- Из каждой части извлекается дата:
  - ключевые слова: "сегодня", "завтра", "послезавтра";
  - даты формата `dd.mm` или `dd/mm`.
- Дата удаляется из текста задачи, а задача сохраняется в БД.

## Структура проекта
```
app/
  main.py                # точка входа, инициализация БД и запуск бота
  config.py              # загрузка BOT_TOKEN из .env
  bot/
    main.py              # создание Bot/Dispatcher и запуск polling
    messages.py          # текстовые сообщения и подсказки
    handlers/
      text.py            # обработка текстовых сообщений и команд
      voice.py           # обработка голосовых сообщений
  asr/
    whisper_asr.py       # конвертация ogg->wav и распознавание речи
  llm/
    task_extractor.py    # разбор текста на задачи и выделение дат
  dates/
    parser.py            # парсер дат
  services/
    tasks.py             # бизнес‑логика работы с задачами
  db/
    database.py          # подключение к SQLite и init схемы
    tasks_repo.py        # CRUD для задач
  schemas/
    task.py              # dataclass модели

data/
  todo.db                # SQLite база задач (создается автоматически)
  audio/                 # временные аудиофайлы
```

## Хранение данных
База данных создается автоматически при первом запуске (`data/todo.db`).
Схема таблицы `tasks`:
- `id` — INTEGER, первичный ключ;
- `user_id` — INTEGER, Telegram ID пользователя;
- `text` — TEXT, текст задачи;
- `due_date` — DATE, опциональная дата (в ISO формате).

## Обработка голосовых сообщений
- Голосовые сообщения сохраняются в `data/audio`.
- OGG конвертируется в WAV через `ffmpeg` (моно, 16 kHz).
- Затем аудио распознается моделью Whisper (`tiny`).
- Распознанный текст показывается пользователю на подтверждение.
- Неподтвержденные запросы удаляются по TTL (15 минут).

## Переменные окружения
| Переменная | Обязательная | Описание |
| --- | --- | --- |
| BOT_TOKEN | да | Токен Telegram‑бота |

## Частые проблемы
- **Не установлен ffmpeg**: убедитесь, что `ffmpeg` доступен из командной строки.
- **Ошибки распознавания**: проверьте, что модель Whisper загрузилась и хватает ресурсов (CPU/RAM).
- **Пустой список задач**: бот не смог выделить задачи из текста, попробуйте явные формулировки.

## Идеи для развития
- Поддержка более сложного NLP разборщика.
- Напоминания и нотификации по времени.
- Веб‑интерфейс или экспорт в календарь.
- Хранение пользователей и задач в отдельном сервисе.

## Лицензия
Проект без явной лицензии. При необходимости добавьте файл `LICENSE`.
