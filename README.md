# Todo Telegram Bot

Telegram-бот для личного списка задач с поддержкой:
- обычных текстовых сообщений;
- команд `/add`, `/list`, `/done`;
- голосовых сообщений (Whisper + `ffmpeg`);
- напоминаний (`/remind`, `/reminders`, `/unremind`).

## Что умеет бот

- Добавлять задачи из текста (командой `/add` или просто сообщением).
- Разбивать одну фразу на несколько задач по союзу `и`.
- Извлекать дату из текста задачи:
  - `сегодня`, `завтра`, `послезавтра`;
  - дата в формате `dd.mm` или `dd/mm`.
- Показывать список задач (`/list`).
- Отмечать задачу выполненной (`/done <номер>` или через inline-кнопки).
- Создавать напоминания для задач (`/remind`).
- Показывать активные напоминания (`/reminders`).
- Удалять напоминания (`/unremind <номер>` или через inline-кнопки).
- Обрабатывать голосовые сообщения:
  1) распознать речь;
  2) показать предпросмотр;
  3) подтвердить или отменить добавление.

## Технологии

- Python 3.11+
- [aiogram 3](https://docs.aiogram.dev/)
- SQLite
- [openai-whisper](https://github.com/openai/whisper)
- `ffmpeg` (для конвертации голосовых сообщений)

## Быстрый старт

### 1. Установите зависимости ОС

Обязательно нужен `ffmpeg` в `PATH`.

### 2. Создайте виртуальное окружение и установите Python-зависимости

```bash
python -m venv .venv
```

Linux/macOS:

```bash
source .venv/bin/activate
pip install -r requirements.txt
```

Windows (PowerShell):

```powershell
.venv\Scripts\Activate.ps1
pip install -r requirements.txt
```

### 3. Настройте `.env`

Создайте файл `.env` в корне проекта:

```env
BOT_TOKEN=ваш_telegram_bot_token
```

### 4. Запуск

```bash
python -m app.main
```

## Команды

- `/start` — показать справку и клавиатуру с командами.
- `/add <текст>` — добавить задачи из текста.
- `/list` — показать текущие задачи.
- `/done <номер>` — отметить задачу выполненной.
- `/remind` — создать напоминание для выбранной задачи.
- `/reminders` — показать список активных напоминаний.
- `/unremind <номер>` — удалить напоминание.

Также можно просто отправить текст без команды — бот попытается извлечь задачи автоматически.

## Примеры

Добавление задач:

```text
/add купить молоко и оплатить интернет завтра
```

Что произойдет:
- фраза разобьется на 2 задачи;
- для второй задачи бот попробует определить дату (`завтра`);
- дата сохранится отдельно от текста задачи.

Создание напоминания:
1. Введите `/remind`.
2. Выберите задачу из списка.
3. Введите время в формате `ЧЧ:ММ` (например, `09:30`).

Логика времени:
- используется часовой пояс `Europe/Moscow`;
- если введенное время еще не наступило сегодня — напоминание сработает сегодня;
- если уже прошло — сработает завтра.

## Как устроены данные

База создается автоматически: `data/todo.db`.

Таблица `tasks`:
- `id` — идентификатор задачи;
- `user_id` — Telegram ID пользователя;
- `text` — текст задачи;
- `due_date` — дата задачи (опционально).

Таблица `reminders`:
- `id` — идентификатор напоминания;
- `user_id` — Telegram ID пользователя;
- `task_id` — ссылка на задачу;
- `time_hhmm` — время в формате `ЧЧ:ММ`;
- `next_fire_at` — ближайшее время срабатывания в UTC;
- `is_active`, `created_at`, `last_fired_at` — служебные поля.

## Структура проекта

```text
app/
  main.py
  config.py
  bot/
    main.py
    messages.py
    handlers/
      text.py
      reminders.py
      voice.py
  asr/
    whisper_asr.py
  llm/
    task_extractor.py
  dates/
    parser.py
  services/
    tasks.py
    reminders.py
  db/
    database.py
    tasks_repo.py
    reminders_repo.py
  schemas/
    task.py
    reminder.py

data/
  todo.db
  audio/
```

## Частые проблемы

- `BOT_TOKEN не найден в .env`  
  Проверьте, что файл `.env` находится в корне проекта и содержит `BOT_TOKEN=...`.

- Ошибка обработки голоса  
  Проверьте, что установлен `ffmpeg` и доступен из терминала.

- Whisper работает медленно  
  Это ожидаемо на слабых CPU. Первый запуск может быть особенно долгим из-за загрузки модели.

## Лицензия

Явная лицензия в репозитории пока не добавлена.
